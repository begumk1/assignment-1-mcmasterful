# Upstream for load balancing between multiple server instances
upstream backend_servers {
    server server1:3000;
    server server2:3000;
    server server3:3000;
}

# Cache configuration
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=books_cache:10m max_size=10g inactive=60m use_temp_path=off;

server {
    listen 80;
    server_name localhost;

    # Front-end proxy
    location / {
        proxy_pass http://front-end:9080/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # API proxy with load balancing and caching for specific routes
    location /api/ {
        # Load balancing across multiple server instances
        proxy_pass http://backend_servers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Add server identification header for debugging
        add_header X-Served-By $upstream_addr;
    }

    # Cached routes - books list without filters and book details
    location ~ ^/api/books/?$ {
        # Use cache for unfiltered book list
        proxy_cache books_cache;
        proxy_cache_valid 200 5m;  # Cache successful responses for 5 minutes
        proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        
        # Load balancing
        proxy_pass http://backend_servers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache headers
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Served-By $upstream_addr;
    }

    # Cached routes - individual book details
    location ~ ^/api/books/[^/]+/?$ {
        # Use cache for individual book details
        proxy_cache books_cache;
        proxy_cache_valid 200 10m;  # Cache successful responses for 10 minutes
        proxy_cache_key "$scheme$request_method$host$request_uri";
        proxy_cache_use_stale error timeout updating http_500 http_502 http_503 http_504;
        proxy_cache_lock on;
        
        # Load balancing
        proxy_pass http://backend_servers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Cache headers
        add_header X-Cache-Status $upstream_cache_status;
        add_header X-Served-By $upstream_addr;
    }

    # Non-cached routes - filtered books, warehouse operations, etc.
    location ~ ^/api/books\? {
        # No caching for filtered requests
        proxy_pass http://backend_servers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header X-Served-By $upstream_addr;
    }

    # Warehouse routes - no caching
    location ~ ^/api/warehouse/ {
        proxy_pass http://backend_servers/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        add_header X-Served-By $upstream_addr;
    }
}
